---
title: "Goldencheetah Import"
author: "Rigler Andreas"
date: "14 9 2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

#Open:
- aggregate sport (running etc)


# Goals:

- import json files from goldencheetah into r
- create an aggregation (1 row for 1 activity)

## Aggregation Results  

Als n√§chstes FTP history einbauen

vielleicht:
-histogrammdaten oder count hr/power


```{r}
library(tidyverse)
library(osmdata)
library(ggmap)
library("jsonlite")
#library(OpenStreetMap)
library(plotly)
library(lubridate)


#custom funcitons
source("functions_ftp_laktat.R")
source("functions_import.R")
```

test

```{r Wattwerte Grenzen}

path_laktat_ftp <- "C:/Users/rigle/Documents/Training/Laktat FTP/"


mmol_2 <- 200
ftp <- 260
watt_z1 <- c(80:(mmol_2-1))
watt_z2 <- c(mmol_2:(ftp*1.1))
watt_z3 <- c(((ftp*1.1)+1):1100)

```

Pfad definieren:
```{r}

pfad_aktivity <- "C:/Users/rigle/AppData/Local/GoldenCheetah/Andl/activities/" 

```

Liste der json files:

```{r}
files <- list.files(pfad_aktivity)


files <- tibble(file_name = files)

files <- files %>% mutate(file_date = str_sub(file_name,1,10),
                          file_year = str_sub(file_name,1,4))

count(files)
```

# Only one day for testing 

```{r}
start_date <- "2015-01-11"
end_date <- "2022-09-11"


date_selected <- tibble(file_date = seq.Date(as.Date(start_date),
                                             as.Date(end_date), 
                                             by = "day") )
date_selected <- date_selected %>% mutate(file_date = str_replace_all(as.character(file_date),"-","_"))

files_selected_all <- files  %>% right_join(date_selected, 
                             by= "file_date") %>% 
                  filter(!is.na(file_name)) %>% #if the date doesn`t exist in the data
                  select(file_name) #%>% pull()




files_selected_all %>% arrange(desc(file_name))

```





## Import FTP data

```{r}

ftp_data <- read_csv2(str_c(path_laktat_ftp,"FTP.csv")) %>% 
                      mutate(date = as.Date(datum, "%d.%m.%Y")) %>% select(-datum)

date_ftp <- add_missing_dates(ftp_data, "ftp")

```




## Import Laktat data

import the calculated 2mmol and 4mmol threshold.
calculated with Lactate_Curve_FTP.rmd

```{r}
laktat_watt <- read_csv2(str_c(path_laktat_ftp,"laktat_watt.csv")) %>% 
                          mutate(date = as.Date(datum, "%d.%m.%Y")) %>% select(-datum) 


laktat_watt_date <- add_missing_dates(laktat_watt, c("w_2mmol", "w_4mmol", "w_5mmol"))
```

```{r}
files_selected = files_selected_all#[1:100,]

```


```{r}
override_data = FALSE  #If override_data = TRUE .. old aggregations will be overwritten, override_data = FALSE.. new date will be appended

file_name_aggreagations <- "Results/aggregations_result_counts.rds"
file_name_watt_count <- "Results/watt_count_result.rds"
file_name_hr_count <- "Results/hr_count_result.rds"
file_name_intervals_result <- "Results/intervals_result.rds"

if( override_data == FALSE){
  #Load allready processed data
 old_aggregations <- read_rds(str_c(path_laktat_ftp, file_name_aggreagations))
 old_watt_count <- read_rds(str_c(path_laktat_ftp, file_name_watt_count))
 old_hr_count <- read_rds(str_c(path_laktat_ftp, file_name_hr_count))
 old_intervals_result <- read_rds(str_c(path_laktat_ftp, file_name_intervals_result))
 
}else{old_aggregations <- tibble(file_name = c(" "))}


data_ride <- list()
data_rides <- list()
aggregation_rides <- list()
watt_count_rides <- list()
hr_count_rides <- list()
aggregation_ride <- tibble()
intervals_rides <- list()

for (i in seq_along(files_selected$file_name)){
  if((!(files_selected$file_name[i] %in% old_aggregations$file_name))){
     datei <- str_c(pfad_aktivity,files_selected$file_name[i])
      try({
           data_ride <- read_json(datei)
           aggregation_ride <- tibble(file_name = files_selected$file_name[i],
                                      workout_code = as.character(data_ride$RIDE$TAGS$`Workout Code`))
           aggregation_ride$device <- data_ride$RIDE$TAGS$Rad
           aggregation_ride$start_time <-data_ride$RIDE$STARTTIME
           aggregation_ride <-aggregation_ride %>% mutate(date = as.Date(start_time))
           
           #connect to the FTP date data
           aggregation_ride <- aggregation_ride %>% left_join(date_ftp, by ="date")
           FTP <- aggregation_ride$ftp
           
           #date for count of hr and watt
           date_ride <- aggregation_ride %>% summarise(max(date,na.rm = TRUE)) %>% pull()
           
           #connect to the laktat watt data
           aggregation_ride <- aggregation_ride %>% left_join(laktat_watt_date, by ="date")
           
            #is there any trainings data?
            samples <- sum(names(data_ride[[1]]) == "SAMPLES")
           
           if (samples == 1) {  #there is trainings data
       
                  ridedata_list <- data_ride[[1]]$SAMPLES
                  ridedata <- bind_rows(ridedata_list)
                  
                  aggregations <- tibble(movement_time_sec = calculate_movement_time(ridedata),
                                         elevation_gain = calculate_elevation_gain(ridedata),
                                         cadence = calculate_cadence(ridedata),
                                         NP = calculate_NP(ridedata),
                                         IF = calculate_IF(ridedata, FTP),
                                         TSS = calculate_TSS(ridedata, FTP),
                                         watt_mean = calculate_w_mean(ridedata),
                                         hr_mean = calculate_hr_mean(ridedata),
                                         
                                         time_2mmol = calculate_time_2mmol_w(ridedata, aggregation_ride$w_2mmol,
                                                                                       w_min = 50),
                                         time_4mmol = calculate_time_4mmol_w(ridedata, aggregation_ride$w_4mmol),
                                         time_below_w_min = calculate_time_below_w_min(ridedata,
                                                                                       w_min = 50),
                                         
                                         w_1min = calculate_best_watt(ridedata,min = 1),
                                         w_5min = calculate_best_watt(ridedata,min = 5),
                                         w_20min = calculate_best_watt(ridedata,min = 20),
                                         w_60min = calculate_best_watt(ridedata,min = 60))
                  
                  aggregation_ride$km <-ridedata%>% summarise(km = max(KM,na.rm = TRUE)) %>% pull()
                  
              #Count Watt and Hr per ride
                  watt_count <- count_watt(ridedata) 
                  hr_count <- count_hr(ridedata)
                  
              #check for overrides               
                  override <- data_ride$RIDE$OVERRIDES
                  if(is.null(override) == FALSE){
                     for (i_ov in seq_along(override)){
                        override_name <- data_ride$RIDE$OVERRIDES[[i_ov]] %>% names()
                        override_value <- data_ride$RIDE$OVERRIDES[[i_ov]][[1]]$value
                        if(override_name == "elevation_gain"){
                          aggregations$elevation_gain <- as.integer(override_value)
                        }else if(override_name == "coggan_tss"){
                          aggregations$TSS <- as.integer(override_value)
                        }
                    }
                  }
  
  
  
                  if(!is.null(data_ride$RIDE$INTERVALS) & sum(names(ridedata) =="WATTS") != 0){
                  intervals_rides[[i]] <- get_intervals(data_ride)
                  }
  
                  
                  aggregation_ride <- aggregation_ride %>% bind_cols(aggregations)
           }else{watt_count <- tibble()}
      })
     
    aggregation_rides[[i]] <- aggregation_ride
    
    watt_count_rides[[i]] <- watt_count %>% mutate(file_name = files_selected$file_name[i],
                                                   date = date_ride)
    hr_count_rides[[i]] <- hr_count %>% mutate(file_name = files_selected$file_name[i],
                                                   date = date_ride)
    
    print(datei)
    
  }
  
  
  if(!is_empty(aggregation_rides)){
  
  aggregations_result <- bind_rows(aggregation_rides) %>% mutate(start_time = as.POSIXct(start_time))
  
  watt_count_result <- bind_rows(watt_count_rides)
  hr_count_result <- bind_rows(hr_count_rides)
  intervals_result <- bind_rows(intervals_rides)
  
  
  if(override_data == FALSE){ 
    #if no update append the new data to the old data:
      aggregations_result <- aggregations_result %>% bind_rows(old_aggregations)
      watt_count_result <- watt_count_result %>% bind_rows(old_watt_count)
      hr_count_result <- hr_count_result %>% bind_rows(old_hr_count)
      intervals_result <- intervals_rides %>% bind_rows(old_intervals_rides)
  }
  
  #Save the result:
  write_rds(aggregations_result, str_c(path_laktat_ftp,file_name_aggreagations))
  write_rds(watt_count_result, str_c(path_laktat_ftp, file_name_watt_count))
  write_rds(hr_count_result, str_c(path_laktat_ftp, file_name_hr_count))
  write_rds(intervals_result, str_c(path_laktat_ftp, file_name_intervals_result))
  
}
}

intervals_result
```

## Intervalle

```{r}
path_laktat_ftp <- "C:/Users/rigle/Documents/Training/Laktat FTP/"
file_name_intervals_result <- "Results/intervals_result.rds"

intervals_result <- read_rds(str_c(path_laktat_ftp, file_name_intervals_result))
```


```{r}
intervals_result %>% mutate(interval = case_when(interval_watt > 260 ~ "FTP", 
                                                 interval_watt > 230 ~ "SST",TRUE ~ "GA1")) %>%
  group_by(date, interval) %>% 
  summarise(seconds = sum(interval_sec)) %>%
  mutate( hours = seconds /3600) %>%
  ggplot(aes(x = date))+
  geom_point(aes(y=hours, color = interval))+
  facet_wrap(interval ~., ncol = 1, scales = "free_y")
```

```{r}
sst_data <- intervals_result %>% mutate(interval = case_when(interval_watt > 260 ~ "FTP", 
                                                 interval_watt > 230 ~ "SST",TRUE ~ "GA1"),
                            year = as.factor(year(date))) %>%
  filter(interval == "SST" &
        interval_sec > 20*60) 

sst_year_data  <- sst_data  %>%
  group_by(year) %>% summarise(watt_mean = mean(interval_watt),
                            hr_mean = mean(interval_hr)) 

sst_data%>%
  ggplot(aes(x=interval_watt))+
  geom_point(aes(y= interval_hr, color = year))+
  geom_point(data = sst_year_data, aes(x = watt_mean, y= hr_mean, color = year), size = 10, alpha = 1/3)
```



```{r}
intervals_result %>% mutate(interval = case_when(interval_watt > 260 ~ "FTP", 
                                                 interval_watt > 230 ~ "SST",TRUE ~ "GA1"),
                            week = isoweek(date),
                            year = year(date)) %>%
  group_by(year, week, interval) %>% 
  summarise(seconds = sum(interval_sec),
            date = min(date,na.rm = TRUE)) %>%
  #filter(date > "2022-01-01")
  
  mutate( hours = seconds /3600) %>%
  ggplot(aes(x = date))+
  geom_point(aes(y = hours, color = interval))+
  geom_smooth(aes(y = hours, color = interval))+
  facet_wrap(interval ~., ncol = 1, scales = "free_y")


```

```{r}
get_intervals_2 <- function(data_ride){
  library(zoo)
  
  intervals_gc_list <- data_ride$RIDE$INTERVALS
  
  intervals_n <- intervals_gc_list %>% length()
  
  intervals_list <- c()
  for (i in c(1:intervals_n)) {
    intervals_list[[i]] <- tibble(
      interval_name = intervals_gc_list[[i]]$NAME,
      interval_start = intervals_gc_list[[i]]$START,
      interval_ptest = intervals_gc_list[[i]]$PTEST
    ) %>% 
      mutate(interval_start = abs(interval_start),
             interval_name = case_when(is.null(interval_name) ~" ",TRUE ~interval_name))
    
  }
  
  
  interval <- intervals_list %>% bind_rows() %>% arrange(interval_start)
  
  # get the ride data
  ridedata_list <- data_ride[[1]]$SAMPLES
  ridedata <- bind_rows(ridedata_list)
  
  
  
  #join with intervals
  ridedata_joined <- ridedata %>% left_join(interval, 
                                            by = c("SECS" = "interval_start")) %>%
    arrange(SECS)     
  
  #fill NA
  ridedata_interval <- ridedata_joined %>% filter(SECS >= !!intervals_list[[1]]$interval_start ) %>%
                                  mutate(interval_name = na.locf(interval_name),
                                         interval_ptest = na.locf(interval_ptest))
  
  #aggregate
  interval_aggregation <- ridedata_interval %>% group_by(interval_name,interval_ptest) %>%
    
    summarise(interval_watt = mean(WATTS, na.rm = TRUE),
              interval_hr = mean(HR, na.rm = TRUE),
              interval_sec = n())
  
  
  interval_aggregation <- interval_aggregation %>% 
    mutate(#file_name = files_selected$file_name[i],
      workout_code = as.character(data_ride$RIDE$TAGS$`Workout Code`),
      device = data_ride$RIDE$TAGS$Rad,
      start_time = data_ride$RIDE$STARTTIME,
      date = as.Date(start_time)) %>% select(date, workout_code, everything())
  
  
  
  
  return( interval_aggregation)
}

get_intervals_2(data_ride)

intervals_list[[1]]$interval_start

test  %>% mutate(interval_name = na.locf(interval_name, na.rm = TRUE),
                                                  interval_ptest = na.locf(interval_ptest, na.rm = TRUE))
test
```


# Hier weitermachen:
trainingsdaten als liste speichern count(watt, hr)


## Aggregation



```{r import data and aggregate}
override_data = TRUE  #If override_data = TRUE .. old aggregations will be overwritten, override_data = FALSE.. new date will be appended

file_name_aggreagations <- "Results/aggregations_result_counts.rds"
file_name_watt_count <- "Results/watt_count_result.rds"
file_name_hr_count <- "Results/hr_count_result.rds"


if( override_data == FALSE){
  #Load allready processed data
 old_aggregations <- read_rds(str_c(path_laktat_ftp, file_name_aggreagations))
 old_watt_count <- read_rds(str_c(path_laktat_ftp, file_name_watt_count))
 old_hr_count <- read_rds(str_c(path_laktat_ftp, file_name_hr_count))
 
}else{old_aggregations <- tibble(file_name = c(" "))}


data_ride <- list()
data_rides <- list()
aggregation_rides <- list()
watt_count_rides <- list()
hr_count_rides <- list()
aggregation_ride <- tibble()
for (i in seq_along(files_selected$file_name)){
  if((!(files_selected$file_name[i] %in% old_aggregations$file_name))){
     datei <- str_c(pfad_aktivity,files_selected$file_name[i])
      try({
           data_ride <- read_json(datei)
           aggregation_ride <- tibble(file_name = files_selected$file_name[i],
                                      workout_code = as.character(data_ride$RIDE$TAGS$`Workout Code`))
           aggregation_ride$device <- data_ride$RIDE$TAGS$Rad
           aggregation_ride$start_time <-data_ride$RIDE$STARTTIME
           aggregation_ride <-aggregation_ride %>% mutate(date = as.Date(start_time))
           
           #connect to the FTP date data
           aggregation_ride <- aggregation_ride %>% left_join(date_ftp, by ="date")
           FTP <- aggregation_ride$ftp
           
           #date for count of hr and watt
           date_ride <- aggregation_ride %>% summarise(max(date,na.rm = TRUE)) %>% pull()
           
           #connect to the laktat watt data
           aggregation_ride <- aggregation_ride %>% left_join(laktat_watt_date, by ="date")
           
            #is there any trainings data?
            samples <- sum(names(data_ride[[1]]) == "SAMPLES")
           
           if (samples == 1) {  #there is trainings data
       
                  ridedata_list <- data_ride[[1]]$SAMPLES
                  ridedata <- bind_rows(ridedata_list)
                  
                  aggregations <- tibble(movement_time_sec = calculate_movement_time(ridedata),
                                         elevation_gain = calculate_elevation_gain(ridedata),
                                         cadence = calculate_cadence(ridedata),
                                         NP = calculate_NP(ridedata),
                                         IF = calculate_IF(ridedata, FTP),
                                         TSS = calculate_TSS(ridedata, FTP),
                                         watt_mean = calculate_w_mean(ridedata),
                                         hr_mean = calculate_hr_mean(ridedata),
                                         
                                         time_2mmol = calculate_time_2mmol_w(ridedata, aggregation_ride$w_2mmol,
                                                                                       w_min = 50),
                                         time_4mmol = calculate_time_4mmol_w(ridedata, aggregation_ride$w_4mmol),
                                         time_below_w_min = calculate_time_below_w_min(ridedata,
                                                                                       w_min = 50),
                                         
                                         w_1min = calculate_best_watt(ridedata,min = 1),
                                         w_5min = calculate_best_watt(ridedata,min = 5),
                                         w_20min = calculate_best_watt(ridedata,min = 20),
                                         w_60min = calculate_best_watt(ridedata,min = 60))
                  
                  aggregation_ride$km <-ridedata%>% summarise(km = max(KM,na.rm = TRUE)) %>% pull()
                  
              #Count Watt and Hr per ride
                  watt_count <- count_watt(ridedata) 
                  hr_count <- count_hr(ridedata)
                  
              #check for overrides               
                  override <- data_ride$RIDE$OVERRIDES
                  if(is.null(override) == FALSE){
                     for (i_ov in seq_along(override)){
                        override_name <- data_ride$RIDE$OVERRIDES[[i_ov]] %>% names()
                        override_value <- data_ride$RIDE$OVERRIDES[[i_ov]][[1]]$value
                        if(override_name == "elevation_gain"){
                          aggregations$elevation_gain <- as.integer(override_value)
                        }else if(override_name == "coggan_tss"){
                          aggregations$TSS <- as.integer(override_value)
                        }
                    }
                  }
  
  
  
  
                  
                  aggregation_ride <- aggregation_ride %>% bind_cols(aggregations)
           }else{watt_count <- tibble()}
      })
     
    aggregation_rides[[i]] <- aggregation_ride
    
    watt_count_rides[[i]] <- watt_count %>% mutate(file_name = files_selected$file_name[i],
                                                   date = date_ride)
    hr_count_rides[[i]] <- hr_count %>% mutate(file_name = files_selected$file_name[i],
                                                   date = date_ride)
    
    print(datei)
  }
}

if(!is_empty(aggregation_rides)){
  
  aggregations_result <- bind_rows(aggregation_rides) %>% mutate(start_time = as.POSIXct(start_time))
  
  watt_count_result <- bind_rows(watt_count_rides)
  hr_count_result <- bind_rows(hr_count_rides)
  
  if(override_data == FALSE){ 
    #if no update append the new data to the old data:
      aggregations_result <- aggregations_result %>% bind_rows(old_aggregations)
      watt_count_result <- watt_count_result %>% bind_rows(old_watt_count)
      hr_count_result <- hr_count_result %>% bind_rows(old_hr_count)
  }
  
  #Save the result:
  write_rds(aggregations_result, str_c(path_laktat_ftp,file_name_aggreagations))
  write_rds(watt_count_result, str_c(path_laktat_ftp, file_name_watt_count))
  write_rds(hr_count_result, str_c(path_laktat_ftp, file_name_hr_count))
}


```




```{r}

aggregations_result %>% mutate(start_time = as.POSIXct(start_time),
                               time_zone2 = movement_time_sec - time_2mmol - time_4mmol - time_below_w_min) %>% 
   ggplot(aes(x=start_time))+
   #geom_point(aes(y=hr_mean, color ="hr"))+
  geom_point(aes(y=time_2mmol/60, color ="time_2mmol"))+
  geom_point(aes(y=time_below_w_min/60, color ="time_below"))+
  geom_point(aes(y=time_4mmol/60, color ="time_4mmol"))+
  geom_point(aes(y=time_zone2/60, color ="time_zone2"))
#   geom_point(aes(y=watt_mean))+
 # geom_line(aes(y=w_2mmol, color = "2mmol"))+
  # geom_line(aes(y= km, color = "km"))+
  #geom_line(aes(y= ftp, color = "FTP"))
```


```{r}
NP_berechnen(ridedata)

calculate_TSS(ridedata,260)
tibble(TSS = calculate_TSS(ridedata,260),
       NP = calculate_NP(ridedata),
       km2 = ridedata%>% summarise(km = max(KM,na.rm = TRUE))%>% pull()) %>%
bind_cols(aggregation_rides[[2]])
```


### Bewegungszeit vs Zeit

2021-09-11  dauer:  7:24:48  4:14:10 zeit, 4:12:42 in bewegung
71,966km h√∂hengewinn: 2001m eingegeben

Ich komme nicht genau hin, besser wird es mit WATTS == 0, aber dann problem mit aktivit√§ten ohne watt..

```{r}
ridedata %>%  mutate(time_diff = SECS - lag(SECS, default = 0),
                     km_diff = KM - lag(KM, default = 0),
                     time_diff_movement = if_else(KPH ==0 & km_diff == 0 , time_diff, time_diff-1)) %>%
              summarise(duration_seconds = (max(SECS)),
                        duration = seconds_to_period(duration_seconds),
                        time_diff = sum(time_diff-1,na.rm = TRUE), #-1 because 1 is the regular time gap
                       aufzeichnungszeit = seconds_to_period(max(SECS) - time_diff ),
                       bewegungszeit = seconds_to_period(max(SECS) - sum(time_diff_movement )),
                       km = sum(km_diff))


```

```{r}
calculate_movement_time <- function(ridedata){
  result <- ridedata %>%  mutate(time_diff = SECS - lag(SECS, default = 0),
                                 km_diff = KM - lag(KM, default = 0),
                                 time_diff_movement = if_else(KPH ==0 & km_diff == 0 , 
                                                              time_diff, time_diff-1)) %>%
              summarise(movement_time = (max(SECS) - sum(time_diff_movement )))  #seconds_to_period()
  return(result$movement_time)
}

calculate_movement_time(ridedata)
```



```{r}
data_prepare <- ridedata %>%mutate(time_diff = SECS - lag(SECS, default = 0),
                     km_diff = KM - lag(KM, default = 0),
                     time_diff_movement = if_else(km_diff ==0, time_diff, time_diff-1),
                    km_diff_factor = if_else(km_diff!=0, "bewegung", "0"))

data_prepare%>%
  ggplot(aes(x = SECS))+
  geom_point(aes(y=KM, color = as.factor(km_diff_factor)))
```

```{r}
data_prepare%>% filter(SECS > 20300 &
                         SECS < 21000) %>%
  ggplot(aes(x = SECS))+
  geom_point(aes(y=KM, color = as.factor(km_diff_factor)))
```

```{r}
data_prepare%>% filter(SECS > 20300 &
                         SECS < 21000) %>%
 mutate(km_diff = KM - lag(KM))%>%
  select(SECS, KM, km_diff, WATTS, KPH, time_diff, km_diff, time_diff_movement) 
```


```{r}
data_prepare %>% arrange(desc(time_diff))
```

### H√∂hengewinn ausrechnen

```{r}
 data_prepare %>% 
            arrange(SECS) %>% mutate(uphill = ALT-lag(ALT),
                        uphill = if_else(uphill >0, 
                                         if_else(uphill < 1,uphill,0), #more than 1m/sec is too much (at the start when no altitude is available)
                                         0)) %>%
  summarise(uphill = sum(uphill,na.rm = TRUE))
```

```{r}
calculate_elevation_gain <- function(ridedata){
   result <- ridedata %>% 
            arrange(SECS) %>% mutate(uphill = ALT-lag(ALT),
                        uphill = if_else(uphill >0, 
                                         if_else(uphill < 1,uphill,0), #more than 1m/sec is too much (at the start when no altitude is available)
                                         0)) %>%
  summarise(uphill = sum(uphill,na.rm = TRUE))
   return(result$uphill)
  
}

calculate_elevation_gain(data_prepare)
```



```{r}
ridedata %>% mutate(sec_diff = SECS - lag(SECS)) %>% count(sec_diff)
```


```{r}
#samples
```



```{r mehrere files}


data_ride <- list()
data_rides <- list()
for (i in seq_along(files_selected$file_name)) {
  print(i)
  datei <- str_c(pfad_aktivity,files_selected$file_name[i])
  try({
     data_ride <- read_json(datei)
     
            #sind trainingsdaten vorhanden ?
            samples <- sum(names(data_ride[[1]]) == "SAMPLES")
            
            if (samples == 1) {
     
                ridedata_list <- data_ride[[1]]$SAMPLES
                ridedata <- bind_rows(ridedata_list)
                ridedata <- ridedata %>% mutate(sec = SECS- lag(SECS),
                                                type = "ohne Daten")
              
            }
  
               
            ridedata <- ridedata %>% mutate(workout = data_ride[[1]]$TAGS$`Workout Code`,
                                            time_start = data_ride[[1]]$STARTTIME,
                                            date = as.Date(time_start), 
                                            year =year(date)  ,
                                            month= month(date),
                                            week = week(date),
                                            time_start = as.POSIXct(time_start),
                                            #beschreibung = data_ride[[1]]$TAGS$Objective, #braucht viel speicher?
                                            cp = data_ride[[1]]$TAGS$CP,
                                            rad = data_ride[[1]]$TAGS$Rad)
            #WATTS enthalten?
            watt <- sum(names(ridedata) == "WATTS")
            
            if (watt == 1) {
              
              ridedata <- ridedata %>% mutate(zone = if_else(WATTS %in% watt_z1,
                                                "Z1",
                                                if_else(WATTS %in% watt_z2, 
                                                        "Z2", 
                                                        if_else(WATTS %in% watt_z3,
                                                                "Z3",
                                                                "easy"))),
                                              type = "Zonen")
            }else{
              ridedata <- ridedata %>% mutate(type = "keine Watt")
            }
            
            
      data_rides[[i]] <-  ridedata
    }) #try ENDE
}

ridedata <- bind_rows(data_rides)

#save the data:
#ridedata %>% write_rds(str_c("./Results/trainingsdata_",year_selected,".rds"))
#ridedata <- read_rds(str_c("./Results/trainingsdata_",year_selected,".rds"))

```

```{r}
ridedata %>% colnames()

ridedata %>% group_by(workout) %>%
              summarise(duration = max(SECS),
                        km = max(KM),
                        elevation_gain = max(ALT))
```

## OFFENE PUNKTEN Letztstand vermutlich



FTP f√ºr die SST berechnung mit ber√ºcksichtigen
--> wichtig w√§re die tss anhand der ftp tabelle zu berechnen, da m√º√üte man mehr werte sch√§tzen oder interpolieren? --> dann herausfinden ob es einen zusammenhang tss/woche und ftp gibt
z.B. tss der letzten 8 wochen --> ftp?

aggregationen: beste 20min, 60min, 5min 1min 10sec.. vielleicht gibt es funktion?
varianz in trainingseinheit ein indiz f√ºr intervalltraining?


vielleicht 5min mittelwerte machen --> streuung und max summarise --> f√ºr Quali von GA1

## Pipeline

```{r}
data_ride <- list()
data_rides <- list()
aggregated_list <- list()
for (i in seq_along(files_selected)) {
  

aggregated <- c()
ridedata_samples <- c()
ridedata <- c()
#aggregated_rides <- list()

  datei <- str_c(pfad_aktivity,files_selected[i])
 try({
     data_ride <- read_json(datei)
     
     
        ridedata <-tibble(workout = data_ride[[1]]$TAGS$`Workout Code`,
                   time_start = as.POSIXct(data_ride[[1]]$STARTTIME),
                   date = as.Date(time_start),
                   year =year(date)  ,
                   month= month(date),
                   week = week(date)) %>%
      mutate(helper = str_to_upper(workout),
                               kategorie = case_when(
                                 str_detect(helper,"GA1") ~ "GA1",
                                 str_detect(helper,"SST") ~ "SST",
                                 str_detect(helper,"VO2MAX") ~ "VO2max",
                                 str_detect(helper,"KRAFTTRAINING") ~ "Krafttraining",
                                 str_detect(helper,"HOUR OF P") ~ "Hour of Power",
                                 str_detect(helper,"FTP TEST") ~ "FTP Test",
                                 str_detect(helper,"RENNEN") ~ "Rennen",
                                 TRUE ~ "Sonstige"
                               )) %>% select(-helper)
 
        #kommt das Feld Rad vor?
 rad <- sum(names(data_ride[[1]]$TAGS) == "Rad")
 if (rad == 1) {
            ridedata$rad <- data_ride[[1]]$TAGS$Rad
 }else{
            ridedata$rad <- ""
 }

#Manuell ver√§nderte Werte wie TSS, h√∂hengwinn:---------------
#Stehen in data_ride[[1]]$OVERRIDES[[1]]

elevation_gain <- sum(names(data_ride[[1]]$OVERRIDES[[1]]) == "elevation_gain")
coggan_tss <- sum(names(data_ride[[1]]$OVERRIDES[[1]]) == "coggan_tss")

print(coggan_tss)
ridedata <- ridedata %>% 
                mutate(TSS = as.numeric(if_else(coggan_tss == 0,
                                                "0",
                                                data_ride[[1]]$OVERRIDES[[1]]$coggan_tss$value)),
                       hoehen_gewinn = as.numeric(if_else(elevation_gain == 0,
                                                         "0",
                                                        data_ride[[1]]$OVERRIDES[[1]]$elevation_gain$value)))



#allgemeine aggregationen----------------------------
   #aggregated_rides[[i]]
   aggregated <-ridedata %>% summarise(workout = first(workout),
                                       kategorie =first(kategorie),
                                          date = first(date),
                                          device = first(rad),
                                       TSS = first(TSS), #sollte TSS manuel eingegeben worden sein
                                       hoehen_gewinn = first(hoehen_gewinn))   
        
#--------------Trainingsdaten---------------------------------------------
#gibt es trainingsdaten?
samples <- sum(names(data_ride[[1]]) == "SAMPLES")
                 
  if (samples == 1) {
    ridedata_list <- data_ride[[1]]$SAMPLES
   ridedata_samples <- bind_rows(ridedata_list) 
   #%>% 
    #                          mutate(WATTS = as.double(WATTS),
     #                                HR = as.double(HR),
      #                               CAD = as.double(CAD))
   
     
  
  # Welche trainingsdaten gibt es - watt, temp,hr,... verschieden je nach sport    
     variablen <-  ridedata_samples %>% colnames()
     variablen_mean <- ridedata_samples %>% select(-SECS, -KM, -ALT, -LAT, -LON, -SLOPE)%>% colnames()

        #Mittelwerte berechnen
         agg_mean <-  ridedata_samples %>% summarise_at(vars(variablen_mean), ~mean(.x,na.rm = TRUE))  
         #Maximalwerte berechnen
         agg_max <- ridedata_samples %>% summarise(km = max(KM),
                                          n=n(),
                                          duration = hms::as_hms(n()))
        aggregated <-  aggregated %>%  bind_cols(agg_mean) %>% bind_cols(agg_max) 
        
        #TSS,NP berechnen
        aggregated <- aggregated %>%  mutate(TSS =  if_else(TSS == 0,
                                                            TSS_berechnen(ridedata_samples,FTP),
                                                            TSS),
                                              NP =  NP_berechnen(ridedata_samples),
                                              IF = IF_berechnen(ridedata_samples,FTP))
        # Beste xmin Watt
        #Vorsicht, langsam
        agg_beste <- c()
        agg_beste <-  tibble(beste_60 = beste_watt(ridedata_samples,60),
                             beste_20 = beste_watt(ridedata_samples,20),
                             beste_10 = beste_watt(ridedata_samples,10),
                             beste_5 = beste_watt(ridedata_samples,5),
                             beste_1 = beste_watt(ridedata_samples,1),
                             beste_3sek = beste_watt(ridedata_samples,3/60),
                             #beste_1sek = beste_watt(ridedata_samples,1/60)
                             )
        aggregated <-  aggregated %>%  bind_cols(agg_beste)
        
        
        #5min auswertung, ziel ist, ga1 einheiten zu bewerten
        agg_w5 <- w5_auswertung(ridedata_samples)
        agg_hr5 <- hr5_auswertung(ridedata_samples)
        aggregated <-  aggregated %>%  bind_cols(agg_w5) %>% bind_cols(agg_hr5)
         
 
  }  
 }) #try
      aggregated_list[[i]] <- aggregated
}

bind_rows(aggregated_list)
```


## Select files by date
```{r}
start_date <- "2021-09-10"
end_date <- "2022-01-01"


#files_select <- files[1400:1420]



date_selected <- tibble(file_date = seq.Date(as.Date(start_date),
                                             as.Date(end_date), 
                                             by = "day") )
date_selected <- date_selected %>% mutate(file_date = str_replace_all(as.character(file_date),"-","_"))

files_selected <- files  %>% right_join(date_selected, 
                             by= "file_date") %>% 
                  filter(!is.na(file_name)) %>% #if the date doesn`t exist in the data
                  select(file_name) %>% pull()




files_selected

```

## Select files per year

```{r}
year_selected <- c("2021")

files_selected <- files %>% filter(file_year %in% year_selected)
```



```{r mehrere files}

data_ride <- list()
data_rides <- list()
for (i in seq_along(files_selected$file_name)) {
  print(i)
  datei <- str_c(pfad_aktivity,files_selected$file_name[i])
  try({
     data_ride <- read_json(datei)
     
            #sind trainingsdaten vorhanden ?
            samples <- sum(names(data_ride[[1]]) == "SAMPLES")
            
            if (samples == 1) {
     
                ridedata_list <- data_ride[[1]]$SAMPLES
                ridedata <- bind_rows(ridedata_list)
                ridedata <- ridedata %>% mutate(sec = SECS- lag(SECS),
                                                type = "ohne Daten")
              
            }
  
               
            ridedata <- ridedata %>% mutate(workout = data_ride[[1]]$TAGS$`Workout Code`,
                                            time_start = data_ride[[1]]$STARTTIME,
                                            date = as.Date(time_start), 
                                            year =year(date)  ,
                                            month= month(date),
                                            week = week(date),
                                            time_start = as.POSIXct(time_start),
                                            #beschreibung = data_ride[[1]]$TAGS$Objective, #braucht viel speicher?
                                            cp = data_ride[[1]]$TAGS$CP,
                                            rad = data_ride[[1]]$TAGS$Rad)
            #WATTS enthalten?
            watt <- sum(names(ridedata) == "WATTS")
            
            if (watt == 1) {
              
              ridedata <- ridedata %>% mutate(zone = if_else(WATTS %in% watt_z1,
                                                "Z1",
                                                if_else(WATTS %in% watt_z2, 
                                                        "Z2", 
                                                        if_else(WATTS %in% watt_z3,
                                                                "Z3",
                                                                "easy"))),
                                              type = "Zonen")
            }else{
              ridedata <- ridedata %>% mutate(type = "keine Watt")
            }
            
            
      data_rides[[i]] <-  ridedata
    }) #try ENDE
}

ridedata <- bind_rows(data_rides)

#save the data:
ridedata %>% write_rds(str_c("./Results/trainingsdata_",year_selected,".rds"))
#ridedata <- read_rds(str_c("./Results/trainingsdata_",year_selected,".rds"))

```


# Analyse
```{r}
ridedata %>% filter(type == "Zonen") %>% group_by(month,zone,rad, time_start) %>% summarise(km=max(KM),
                                    hr = mean(HR),
                                    watt = mean(WATTS),
                                    zeit = sum(sec,na.rm = TRUE)) %>%
  group_by(month, zone) %>% summarise(km = sum(km),
                                    hr = mean(hr),
                                    watt = mean(watt),
                                    zeit = sum(zeit,na.rm = TRUE)/3600) %>%
  ggplot(aes(x=month))+
  geom_point(aes(y=zeit, color=as.factor(zone)))#+
  geom_point(aes(y=hr, color = "HR"))
```


```{r}
#write_rds(ridedata,"test_mit_beschreibung.rds")

#ridedata <- read_rds("test_mit_beschreibung.rds")
```

```{r}
ridedata %>% group_by(week,rad,time_start, date) %>% summarise(km=max(KM),
                                    hr = mean(HR),
                                    watt = mean(WATTS)) %>%
  group_by(date) %>% 
      summarise(km = sum(km)) %>% 
        arrange(date) %>%
          mutate(km_cum = cumsum(km)) %>%
  ggplot(aes(x=date))+
  geom_line(aes(y= km_cum))
```

```{r}
ridedata %>% group_by(week,rad,time_start, date) %>% summarise(km=max(KM),
                                    hr = mean(HR),
                                    watt = mean(WATTS)) %>%
  group_by(date) %>% 
      summarise(km = sum(km)) %>% 
        arrange(date) %>%
          mutate(km_cum = cumsum(km)) %>%
  ggplot(aes(x=date))+
  geom_line(aes(y= km_cum))
```



```{r}
ridedata %>% group_by(week,rad,time_start, date) %>% summarise(km=max(KM),
                                    hr = mean(HR),
                                    watt = mean(WATTS)) %>%
  group_by(rad,date) %>% 
      summarise(km = sum(km)) %>% 
  
        arrange(date) %>%
          mutate(km_cum = cumsum(km)) %>% #filter(rad=="P2Cros ")
  ggplot(aes(x=date))+
  geom_line(aes(y= km_cum, color = rad))
```




```{r}
ridedata %>% group_by(week,rad,time_start, date) %>% summarise(km=max(KM),
                                    hr = mean(HR),
                                    watt = mean(WATTS)) %>%
  group_by(date) %>% 
      summarise(hr = mean(hr),
                watt = mean(watt)) %>% 
  ggplot(aes(x=date))+
  geom_line(aes(y= hr, color ="hr"))+
  geom_line(aes(y=watt, color = "watt"))
```



```{r}
ridedata %>% group_by(week,zone,rad, time_start) %>% summarise(km=max(KM),
                                    hr = mean(HR),
                                    watt = mean(WATTS)) %>%
  group_by(week, zone) %>% summarise(km = sum(km),
                                    hr = mean(hr),
                                    watt = mean(watt)) %>%
  ggplot(aes(x=hr))+
  geom_point(aes(y=watt, color=as.factor(week)))+
  geom_point(aes(y=hr, color = "HR"))+
  facet_grid(zone~.)

```

```{r}
ridedata  %>% group_by(month,rad, time_start) %>% summarise(km=max(KM),
                                    hr = mean(HR),
                                    watt = mean(WATTS)) %>%
  group_by(month) %>% summarise(km = sum(km),
                                    hr = mean(hr),
                                    watt = mean(watt)) %>%
  ggplot(aes(x=watt))+
  #geom_point(aes(y=watt, color="watt"))+
  geom_point(aes(y=hr, color = as.factor(month)))

```


```{r}
ridedata %>% glimpse()
 ridedata %>% summary()

```

```{r}
ridedata %>% mutate(date = as.Date(time_start), 
                    year =year(date)  ,
                    month= month(date),
                    week = week(date),
                    time_start = as.POSIXct(time_start)) %>% 
  select(time_start, date, year, month, week)
```



```{r}
datei_info <- gc_data[[1]][[6]]
datei_info$`Workout Code`
datei_info$Objective
```

```{r}

#MEtriken √Ñnderung:
data4[[1]][[5]]
```

```{r}
#Intervalle
data4[[1]][[7]]
```

```{r}

ridedata_list <- gc_data[[1]][[8]]
ridedata <- bind_rows(ridedata_list)

```

```{r}
ridedata %>% ggplot(aes(x=SECS))+
  geom_point(aes(y=WATTS, color = "Watt"))+
  labs(title = datei_info$`Workout Code`)

```
## Mehrere Dateien Watt auslesen

```{r}
files <- list.files(pfad_aktivity)
summary(files)
```

```{r mehrere files}
files_select <- files[1300:1420]

data_ride <- list()
data_rides <- list()
for (i in seq_along(files_select)) {
  datei <- str_c(pfad_aktivity,files_select[i])
   data_ride <- read_json(datei)
          ridedata_list <- data_ride[[1]]$SAMPLES
          ridedata <- bind_rows(ridedata_list)
   
          ridedata <- ridedata %>% mutate(workout = data_ride[[1]]$TAGS$`Workout Code`,
                                          time_start = data_ride[[1]]$STARTTIME,
                                          beschreibung = data_ride[[1]]$TAGS$Objective,
                                          cp = data_ride[[1]]$TAGS$CP,
                                          rad = data_ride[[1]]$TAGS$Rad)
    data_rides[[i]] <-  ridedata

}

ridedata <- bind_rows(data_rides)

data_ride[[1]]$DEVICETYPE
```

```{r}
ridedata %>% group_by(rad) %>% summarise(max(WATTS))
```



```{r}

### Karte
ridedata %>% filter(LAT > 40 ) %>% ggplot( aes(LON, LAT)) + 
  geom_point(aes(color= WATTS),size = .25, show.legend = FALSE) +
  coord_quickmap()#coord_sf()


```

```{r osmdata}

#https://dominicroye.github.io/en/2018/accessing-openstreetmap-data-with-r/
q <- getbb("Madrid") %>%
      opq() %>%
       add_osm_feature("amenity", "cinema")

str(q)

cinema <- osmdata_sf(q)
cinema

#our background map
mad_map <- get_map(getbb("niederoesterreich"), maptype = "toner-background")

ggmap(mad_map)
?get_map
?getbb

test <- ridedata %>% filter(LAT > 40 ) 

background <- get_map(location = c(14.6,48))
ggmap(mad_map)
ggmap(mad_map) + geom_point(data = test,aes(x=LON,y=LAT)) #+  coord_cartesian(xlim=c(14.5,15))

mapi <- openmap(c(lat= 14.5,   lon= 14.7),
			c(lat= 47,   lon= 49), minNumTiles=9)#, type ="maptoolkit-topo") 
  
?openmap

```



```{r}
files <- list.files(pfad_aktivity)
```

```{r}
selected_files <- files[1400:1411]
gc_data_list <- list()
ridedata <- list()
for (i in seq_along(selected_files)) {

  gc_data <- read_json(str_c(pfad_aktivity, selected_files[i]))
  ridedata_list <- gc_data[[1]][[8]]
  ridedata[[i]] <- bind_rows(ridedata_list)

}

test <- bind_rows(ridedata)
```

```{r}
### Karte
test %>% filter(LAT > 2) %>% ggplot( aes(LON, LAT)) + 
  geom_point(aes(color= WATTS),size = .25, show.legend = FALSE) +
  coord_quickmap()#coord_sf()

```

```{r}
heat <- test %>% filter(LAT >47.96 &
                          LAT < 47.968 &
                          LON > 14.76 &
                          LON < 14.79) %>% 
  group_by(LAT,LON) %>% count
```

```{r}
plot1 <-heat %>% filter(LAT > 2) %>% ggplot( aes(LON, LAT)) + 
  geom_point(aes(color= n),size = .25, show.legend = FALSE)+
  scale_color_gradient(low = "blue", high = "red")  #+coord_quickmap()#coord_sf()

ggplotly(plot1)
```

```{r}
require(maps)
require(ggplot2)

mp <- openmap(c(53.38332836757155,-130.517578125),
		c(15.792253570362446,-67.939453125),4,'stamen-watercolor')
mp_bing <- openmap(c(53.38332836757155,-130.517578125),
		c(15.792253570362446,-67.939453125),4,'bing')
states_map <- map_data("state")
states_map_merc <- as.data.frame(
		projectMercator(states_map$lat,states_map$long))
states_map_merc$region <- states_map$region
states_map_merc$group <- states_map$group
crimes <- data.frame(state = tolower(rownames(USArrests)), USArrests)

p <- autoplot(mp,expand=FALSE) + geom_polygon(aes(x=x,y=y,group=group),
		data=states_map_merc,fill="black",colour="black",alpha=.1) + theme_bw()
print(p)
p <- autoplot(mp_bing) + geom_map(aes(x=-10000000,y=4000000,map_id=state,fill=Murder),
		data=crimes,map=states_map_merc)
print(p)

```

