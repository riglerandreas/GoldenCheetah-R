---
title: "Feature Pipeline"
author: "ari"
date: '2023-01-09'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Description
Goal:
Create Features for a ML model, to predict the ftp based on the actual training data (history)

Input:
- ftp/laktat data (for the season dates and to calculate the right intensity and etc.)
- weeks/season
- gc activities aggregated/activity
- Interval aggregations

Output:
Aggregation of every season as a feature

## Parameters
```{r}
library(tidyverse)

source("functions_ftp_laktat.R")
source("functions_import.R")
source("functions_sesons.R")
source("functions_intervall.R")
```

```{r}
weeks_per_season = 12


intensity_min <- 0.88 #minimum intensity to count as an Interval intensity = watt_interval_mean/watt_ftp
device_list = c("BAsso_Vector", "P2M", "P2Cros", "P2MIndoor") # List of trust able devices for interval aggregation

path_ftp_tests <- "C:/Users/rigle/Documents/Training/Laktat FTP/laktat_watt_ftp.csv"
path_intervalls <- "Results/intervall_aggregation.csv"
path_activities <- "Results/goldencheetah_tss.csv"
path_activities_raw <- "C:/Users/rigle/AppData/Local/GoldenCheetah/Andl/activities/"   
```

## FTP / Laktat Data
```{r}

laktat_results<- read_csv2(path_ftp_tests) %>% mutate(date = as.Date(date, format = "%d.%m.%Y"))
```

### ftp values
```{r}
ftp_values <- add_missing_dates(laktat_results,colname="w_5mmol")

ftp_values%>%
  ggplot(aes(x=date, y = w_5mmol))+
  geom_line()
```


### Calculate the FTP from the Lactat

Analyse_seasons_v1.Rmd

## Activity data

```{r}
data_gc <-  read_csv(path_activities)

data_gc <- prepare_gc_summary(data_gc)
```


## Intervals

### update intervals

```{r}
update_intervals <-function(path_activities_gc, path_intervalls){
  library("jsonlite")
  
  result_old <- read_csv2(path_intervalls)
  max_date <- result_old %>% summarise(max(date)) %>% pull() + 1 
  
  print(str_c("last processed: ", max_date))
  
  #get all new files
  files_sel <- choose_files(path_activities_gc, max_date,Sys.Date())
  
  result_list <- list()
    for (i in seq_along(files_sel$file_name)) {
      
      file_sel <- files_sel[i,]
      result_list[[i]] <- read_intervals(path_activities_gc, file_sel)
    }
  result <- bind_rows(result_list)

  result_new <- result_old %>% bind_rows(result) %>% arrange(desc(date))
  result_new %>% write_csv2(path_intervalls)  
  
  return(result_new)
}




```

```{r}
data_intervals_raw <- update_intervals(path_activities_raw, path_intervalls)


```



### process intervalls


```{r}

data_intervals <- extract_intervals(data_intervals_raw, device_list, ftp_values)



data_intervals %>% group_by(date) %>% summarise(min = sum(min)) %>%
  ggplot(aes(x=date, y = min)) + 
  geom_point() +
  theme_light()
```


## Join and aggregate

```{r}
seasons_laktat_watt <- laktat_results 

data_season <- generate_season_summary(lactat_data = laktat_results, 
                                  data_gc = data_gc, 
                                  data_intervals = data_intervals,
                                  weeks_per_season)

#data_season %>% arrange(date_test) %>% select(year, date_test, everything())
```


```{r}

data_season  %>% select(date_test, watt_5mmol, n_interval:interval_min) %>% 
  ggplot(aes(x=date_test)) + geom_point(aes(y= interval_min, color = watt_5mmol))+
                                          geom_line(aes(y= interval_min, color = watt_5mmol))+
  labs(x = "",
       y = "interval [min]",
       title = str_c(weeks_per_season, " weeks per season"))+
  theme_light()
```

```{r}
data_season  %>% #select(date_test, watt_5mmol, n_interval:interval_min) %>% 
  ggplot(aes(x=interval_min)) + geom_point(aes(y= watt_5mmol, color = year))+
    labs(y = "W 5mmol",
       x = "interval [min]",
       color = "",
       title = str_c(weeks_per_season, " weeks per season"))+
  theme_light()
```


```{r}

season_weeks <- c(4,6,8,10,12)

data_seasons_list <- list()

for (i in seq_along(season_weeks)) {
  
  weeks_sel <- season_weeks[i]
  
  data_seasons_list[[i]] <- generate_season_summary(lactat_data = laktat_results, 
                                  data_gc = data_gc, 
                                  data_intervals = data_intervals,
                                   weeks_sel)  %>% mutate(weeks = weeks_sel)
  
}

data_seasons <-  bind_rows(data_seasons_list) 

data_season_today <- data_seasons %>% filter(date_test == max(date_test))

data_seasons %>% #select(date_test, watt_5mmol, n_interval:interval_min) %>% 
  ggplot(aes(x=interval_min)) + geom_point(aes(y= watt_5mmol, color = as.factor(weeks)))+
  geom_vline(data = data_season_today,aes(xintercept = data_season_today$interval_min), linetype = 2)+
  facet_wrap(weeks~., scales = "free_x")+
  theme_light()


```
