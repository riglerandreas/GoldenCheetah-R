---
title: "Goldencheetah Import"
author: "Rigler Andreas"
date: "14 9 2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

#Open:
- aggregate sport (running etc)


# Goals:

- import json files from goldencheetah into r
- create an aggregation (1 row for 1 activity)

## Aggregation Results  

Als nächstes FTP history einbauen

vielleicht:
-histogrammdaten oder count hr/power


```{r}
library(tidyverse)
library(osmdata)
library(ggmap)
library("jsonlite")
#library(OpenStreetMap)
library(plotly)
library(lubridate)
```

test

```{r Wattwerte Grenzen}

path_laktat_ftp <- "C:/Users/rigle/Documents/Training/Laktat FTP/"


mmol_2 <- 200
ftp <- 260
watt_z1 <- c(80:(mmol_2-1))
watt_z2 <- c(mmol_2:(ftp*1.1))
watt_z3 <- c(((ftp*1.1)+1):1100)

```

Pfad definieren:
```{r}

pfad_aktivity <- "C:/Users/rigle/AppData/Local/GoldenCheetah/Andl/activities/" 

```

Liste der json files:

```{r}
files <- list.files(pfad_aktivity)


files <- tibble(file_name = files)

files <- files %>% mutate(file_date = str_sub(file_name,1,10),
                          file_year = str_sub(file_name,1,4))

count(files)
```

# Only one day for testing 

```{r}
start_date <- "2015-01-01"
end_date <- "2022-01-01"


date_selected <- tibble(file_date = seq.Date(as.Date(start_date),
                                             as.Date(end_date), 
                                             by = "day") )
date_selected <- date_selected %>% mutate(file_date = str_replace_all(as.character(file_date),"-","_"))

files_selected <- files  %>% right_join(date_selected, 
                             by= "file_date") %>% 
                  filter(!is.na(file_name)) %>% #if the date doesn`t exist in the data
                  select(file_name) #%>% pull()




files_selected 

```





## Funktionen



```{r}
#-----------Movement time:

calculate_movement_time <- function(ridedata){
  result <- ridedata %>%  mutate(time_diff = SECS - lag(SECS, default = 0),
                                 km_diff = KM - lag(KM, default = 0),
                                 time_diff_movement = if_else(KPH ==0 & km_diff == 0 , 
                                                              time_diff, time_diff-1)) %>%
              summarise(movement_time = (max(SECS) - sum(time_diff_movement )))  #seconds_to_period()
  return(result$movement_time)
}




#------------elevation gain:--------------------------------------------------------------------

calculate_elevation_gain <- function(ridedata){
  if (sum(colnames(ridedata) %>% str_detect("ALT")) == 0){
    return(as.numeric(NA))
  }else{
   result <- ridedata %>% 
            arrange(SECS) %>% mutate(uphill = ALT-lag(ALT),
                                     uphill = as.integer(uphill),
                        uphill = if_else(uphill >0, 
                                         if_else(uphill < 1,uphill,0L), #more than 1m/sec is too much (at the start when no altitude is available)
                                         0L)) %>%
  summarise(uphill = sum(uphill,na.rm = TRUE))
   return(result$uphill)
  }
  
}



#------------mean cadence:--------------------------------------------------------------------

calculate_cadence <- function(ridedata){
  if (sum(colnames(ridedata) %>% str_detect("CAD")) == 0){
    return(as.numeric(NA))
  }else{
   result <- ridedata %>% summarise(cadence = mean(CAD), na.rm = TRUE)

   return(result$cadence)
  }
  
}



#===================TIME in ZONE==================================================

#------------2mmol--------------------------------------------
calculate_time_2mmol_w <- function(d,w_2mmol, w_min = 50){
  #w_min ... time below this watt doesn't count
  if (sum(names(d) =="WATTS") == 0| is.na(w_2mmol)) {
    return(as.numeric(NA))
  }else{
      d<-d %>% select(WATTS) %>% 
            filter(WATTS <= w_2mmol &
                   WATTS > w_min) %>%
                  summarise(time_2mmol = n())
    
      return(d$time_2mmol)
  }
}

#------------4mmol--------------------------------------------
calculate_time_4mmol_w <- function(d,w_4mmol){
  if (sum(names(d) =="WATTS") == 0| is.na(w_4mmol)) {
    return(as.numeric(NA))
  }else{
      d<-d %>% select(WATTS) %>% 
            filter(WATTS >= w_4mmol) %>%
                  summarise(time_4mmol = n())
    
      return(d$time_4mmol)
  }
}

#------------below w_min--------------------------------------------
calculate_time_below_w_min <- function(d, w_min = 50){
  if (sum(names(d) =="WATTS") == 0) {
    return(as.numeric(NA))
  }else{
      d<-d %>% select(WATTS) %>% 
            filter(WATTS <= w_min) %>%
                  summarise(time_below_w_min = n())
    
      return(d$time_below_w_min)
  }
}




#----------Notebook 3_Aktivitäten_analysieren_v4.Rmd--------------------------------------
calculate_hr_mean <- function(d){
  if (sum(names(d) =="HR") == 0) {
    return(as.numeric(NA))
  }else{
      d<-d %>% select(HR) %>% 

                    summarise(hr_mean = as.integer(mean(HR,na.rm = TRUE)))
    
      return(d$hr_mean)
      }
}


calculate_w_mean <- function(d){
  if (sum(names(d) =="WATTS") == 0) {
    return(as.numeric(NA))
  }else{
      d<-d %>% select(WATTS) %>% 

                    summarise(watt_mean = mean(WATTS,na.rm = TRUE))
    
      return(d$watt_mean)
      }
}
  
calculate_NP <- function(d){
  if (sum(names(d) =="WATTS") == 0) {
    return(as.numeric(NA))
  }else{
      d<-d %>% select(WATTS) %>% 
                 mutate(watt = as.ts(WATTS,frequency = 1), #Timeseries machen
                        watt_average =pracma::movavg(watt,25,type = "e"),#  ma(watt,order =60),  #gleitendender bzw. expon mittelwert
                        watt_4 = watt_average^4) %>%  #4potenz
                    summarise(watt_np = (mean(watt_4, na.rm=TRUE))^(1/4))
    
      return(d$watt_np)
      }

#TSS = (Sek x NP® x IF®)/(FTP x 3600) x 100
}

calculate_IF <- function(d,FTP){
  if (sum(names(d) =="WATTS") == 0) {
    return(as.numeric(NA))
  }else{
      d<-d %>% select(WATTS) %>% 
                 mutate(watt = as.ts(WATTS,frequency = 1), #Timeseries machen
                        watt_average =pracma::movavg(watt,25,type = "e"),#  ma(watt,order =60),  #gleitendender bzw. expon mittelwert
                        watt_4 = watt_average^4) %>%  #4potenz
                    summarise(watt_mean = mean(WATTS),
                              watt_np = (mean(watt_4, na.rm=TRUE))^(1/4),
                              watt_average = mean(watt_average, na.rm=TRUE),
                              sek = n()#
                              ) %>%
      mutate(intensity = watt_np/FTP)
      return(d$intensity)
      }
}

calculate_TSS <- function(d,FTP){
    if (sum(names(d) =="WATTS") == 0) {
    return(as.numeric(NA))
  }else{
      d<-d %>% select(WATTS) %>% 
                 mutate(watt = as.ts(WATTS,frequency = 1), #Timeseries machen
                        watt_average =pracma::movavg(watt,25,type = "e"),#  ma(watt,order =60),  #gleitendender bzw. expon mittelwert
                        watt_4 = watt_average^4) %>%  #4potenz
                    summarise(watt_mean = mean(WATTS),
                              watt_np = (mean(watt_4, na.rm=TRUE))^(1/4),
                              watt_average = mean(watt_average, na.rm=TRUE),
                              sek = n()#
                              ) %>%
      mutate(intensity = watt_np/FTP,
             TSS = as.integer((sek* watt_np * intensity)/(FTP * 3600)*100))
      return(d$TSS)
      }

#TSS = (Sek x NP® x IF®)/(FTP x 3600) x 100
}


# BESTE Watt über x minuten
calculate_best_watt <- function(d,min){

  dauer <- d %>% summarise(n())
  if(dauer < 60*min |
     sum(names(d) =="WATTS") == 0){
    return(as.numeric(NA))
    }else{
  
        d<- d %>% select(SECS,WATTS) %>% 
             mutate(watt = as.ts(WATTS,frequency = 1), #Timeseries machen
                    #watt_average = rollmean(WATTS,x*60)
                    watt_average =pracma::movavg(watt,min*60, type = c("s"))
                    ) %>% summarise(beste_watt = max(watt_average))
        return(d$beste_watt)
        }
}

calculate_best_hr5 <- function(d){ 
    if(sum(names(d) =="HR") == 0){
  return(as.numeric(NA))
    }else{
  d<-d %>% mutate(hr = as.ts(HR,frequency = 1), #Timeseries machen
                   hr_5 = pracma::movavg(hr,60*5, type = c("s"))) %>%
  summarise(hr5_mean = mean(hr_5),
         hr5_median = median(hr_5),
         hr5_sd = sd(hr_5))
      return(d)
  
  }
}

calculate_best_w5 <- function(d){ 
    if(sum(names(d) =="WATTS") == 0){
  return(as.numeric(NA))
    }else{
  d<-d %>% filter(WATTS >50) %>%   # sonst ergeben sich durchs bergabfahren verzerrungen?
            mutate(watt = as.ts(WATTS,frequency = 1), #Timeseries machen
                   watt_5 = pracma::movavg(watt,60*5, type = c("s"))) %>%
  summarise(w5_mean = mean(watt_5),
         w5_median = median(watt_5),
         w5_sd = sd(watt_5),
         zeit_mit_w = hms::as_hms(n()))
      return(d)
  
  }
}

#================================== COUNT WATT and HR==============================

count_watt <- function(d){ 
    if(sum(names(d) =="WATTS") == 0){
  return(tibble())
    }else{
  d<-d %>% mutate(watt= as.integer(WATTS)) %>% count(watt) 
      return(d)
  
  }
}

count_hr <- function(d){ 
    if(sum(names(d) =="WATTS") == 0){
  return(tibble())
    }else{
  d<-d %>% mutate(hr= as.integer(HR)) %>% count(hr)
      return(d)
  
  }
}

count_hr(ridedata)

```

## Import FTP data

```{r}
ftp_data_raw <- read_csv2(str_c(path_laktat_ftp,"FTP.csv"))

ftp_data <- ftp_data_raw %>% mutate(date = as.Date(datum, "%d.%m.%Y")) %>% select(-datum) %>% arrange(date)%>% mutate(date_max = lead(date) - 1,
                    date_min = date,
                    date_max = if_else(is.na(date_max),Sys.Date(),date_max))

i=1

ftp_date_data <- list()
for(i in seq_along(ftp_data$date)){
    date_ftp <-tibble(date = seq(ftp_data[i,]$date_min,ftp_data[i,]$date_max, by ="day"))
    date_ftp$ftp <- ftp_data[i,]$ftp
    ftp_date_data[[i]] <- date_ftp
  }
date_ftp <- bind_rows(ftp_date_data)
date_ftp
```

## Import Laktat data

import the calculated 2mmol and 4mmol threshold.
calculated with Lactate_Curve_FTP.rmd

```{r}
laktat_watt_raw <- read_csv2(str_c(path_laktat_ftp,"laktat_watt.csv"))

laktat_watt <- laktat_watt_raw %>% mutate(date = as.Date(datum, "%d.%m.%Y")) %>% select(-datum) %>% 
                      arrange(date)%>% 
              mutate(date_max = lead(date) - 1,
                    date_min = date,
                    date_max = if_else(is.na(date_max),Sys.Date(),date_max))



laktat_watt_date_data <- list()
for(i in seq_along(laktat_watt$date)){
    laktat_watt_date <-tibble(date = seq(laktat_watt[i,]$date_min,
                                         laktat_watt[i,]$date_max, by ="day"))
    laktat_watt_date$w_2mmol <- laktat_watt[i,]$w_2mmol
    laktat_watt_date$w_4mmol <- laktat_watt[i,]$w_4mmol
    laktat_watt_date$w_5mmol <- laktat_watt[i,]$w_5mmol
    laktat_watt_date_data[[i]] <- laktat_watt_date
  }
laktat_watt_date <- bind_rows(laktat_watt_date_data)
laktat_watt_date
```



# Hier weitermachen:
trainingsdaten als liste speichern count(watt, hr)


## Aggregation



```{r import data and aggregate}
override_data = TRUE  #If override_data = TRUE .. old aggregations will be overwritten, override_data = FALSE.. new date will be appended

file_name_aggreagations <- "Results/aggregations_result_counts.rds"
file_name_watt_count <- "Results/watt_count_result.rds"
file_name_hr_count <- "Results/hr_count_result.rds"


if( override_data == FALSE){
  #Load allready processed data
 old_aggregations <- read_rds(str_c(path_laktat_ftp, file_name_aggreagations))
 old_watt_count <- read_rds(str_c(path_laktat_ftp, file_name_watt_count))
 old_hr_count <- read_rds(str_c(path_laktat_ftp, file_name_hr_count))
 
}else{old_aggregations <- tibble(file_name = c(" "))}


data_ride <- list()
data_rides <- list()
aggregation_rides <- list()
watt_count_rides <- list()
hr_count_rides <- list()
aggregation_ride <- tibble()
for (i in seq_along(files_selected$file_name)){
  if((!(files_selected$file_name[i] %in% old_aggregations$file_name))){
     datei <- str_c(pfad_aktivity,files_selected$file_name[i])
      try({
           data_ride <- read_json(datei)
           aggregation_ride <- tibble(file_name = files_selected$file_name[i],
                                      workout_code = as.character(data_ride$RIDE$TAGS$`Workout Code`))
           aggregation_ride$device <- data_ride$RIDE$TAGS$Rad
           aggregation_ride$start_time <-data_ride$RIDE$STARTTIME
           aggregation_ride <-aggregation_ride %>% mutate(date = as.Date(start_time))
           
           #connect to the FTP date data
           aggregation_ride <- aggregation_ride %>% left_join(date_ftp, by ="date")
           FTP <- aggregation_ride$ftp
           
           #date for count of hr and watt
           date_ride <- aggregation_ride %>% summarise(max(date,na.rm = TRUE)) %>% pull()
           
           #connect to the laktat watt data
           aggregation_ride <- aggregation_ride %>% left_join(laktat_watt_date, by ="date")
           
            #is there any trainings data?
            samples <- sum(names(data_ride[[1]]) == "SAMPLES")
           
           if (samples == 1) {  #there is trainings data
       
                  ridedata_list <- data_ride[[1]]$SAMPLES
                  ridedata <- bind_rows(ridedata_list)
                  
                  aggregations <- tibble(movement_time_sec = calculate_movement_time(ridedata),
                                         elevation_gain = calculate_elevation_gain(ridedata),
                                         cadence = calculate_cadence(ridedata),
                                         NP = calculate_NP(ridedata),
                                         IF = calculate_IF(ridedata, FTP),
                                         TSS = calculate_TSS(ridedata, FTP),
                                         watt_mean = calculate_w_mean(ridedata),
                                         hr_mean = calculate_hr_mean(ridedata),
                                         
                                         time_2mmol = calculate_time_2mmol_w(ridedata, aggregation_ride$w_2mmol,
                                                                                       w_min = 50),
                                         time_4mmol = calculate_time_4mmol_w(ridedata, aggregation_ride$w_4mmol),
                                         time_below_w_min = calculate_time_below_w_min(ridedata,
                                                                                       w_min = 50),
                                         
                                         w_1min = calculate_best_watt(ridedata,min = 1),
                                         w_5min = calculate_best_watt(ridedata,min = 5),
                                         w_20min = calculate_best_watt(ridedata,min = 20),
                                         w_60min = calculate_best_watt(ridedata,min = 60))
                  
                  aggregation_ride$km <-ridedata%>% summarise(km = max(KM,na.rm = TRUE)) %>% pull()
                  
              #Count Watt and Hr per ride
                  watt_count <- count_watt(ridedata) 
                  hr_count <- count_hr(ridedata)
                  
              #check for overrides               
                  override <- data_ride$RIDE$OVERRIDES
                  if(is.null(override) == FALSE){
                     for (i_ov in seq_along(override)){
                        override_name <- data_ride$RIDE$OVERRIDES[[i_ov]] %>% names()
                        override_value <- data_ride$RIDE$OVERRIDES[[i_ov]][[1]]$value
                        if(override_name == "elevation_gain"){
                          aggregations$elevation_gain <- as.integer(override_value)
                        }else if(override_name == "coggan_tss"){
                          aggregations$TSS <- as.integer(override_value)
                        }
                    }
                  }
  
  
  
  
                  
                  aggregation_ride <- aggregation_ride %>% bind_cols(aggregations)
           }else{watt_count <- tibble()}
      })
     
    aggregation_rides[[i]] <- aggregation_ride
    
    watt_count_rides[[i]] <- watt_count %>% mutate(file_name = files_selected$file_name[i],
                                                   date = date_ride)
    hr_count_rides[[i]] <- hr_count %>% mutate(file_name = files_selected$file_name[i],
                                                   date = date_ride)
    
    print(datei)
  }
}

if(!is_empty(aggregation_rides)){
  
  aggregations_result <- bind_rows(aggregation_rides) %>% mutate(start_time = as.POSIXct(start_time))
  
  watt_count_result <- bind_rows(watt_count_rides)
  hr_count_result <- bind_rows(hr_count_rides)
  
  if(override_data == FALSE){ 
    #if no update append the new data to the old data:
      aggregations_result <- aggregations_result %>% bind_rows(old_aggregations)
      watt_count_result <- watt_count_result %>% bind_rows(old_watt_count)
      hr_count_result <- hr_count_result %>% bind_rows(old_hr_count)
  }
  
  #Save the result:
  write_rds(aggregations_result, str_c(path_laktat_ftp,file_name_aggreagations))
  write_rds(watt_count_result, str_c(path_laktat_ftp, file_name_watt_count))
  write_rds(hr_count_result, str_c(path_laktat_ftp, file_name_hr_count))
}


```




```{r}

aggregations_result %>% mutate(start_time = as.POSIXct(start_time),
                               time_zone2 = movement_time_sec - time_2mmol - time_4mmol - time_below_w_min) %>% 
   ggplot(aes(x=start_time))+
   #geom_point(aes(y=hr_mean, color ="hr"))+
  geom_point(aes(y=time_2mmol/60, color ="time_2mmol"))+
  geom_point(aes(y=time_below_w_min/60, color ="time_below"))+
  geom_point(aes(y=time_4mmol/60, color ="time_4mmol"))+
  geom_point(aes(y=time_zone2/60, color ="time_zone2"))
#   geom_point(aes(y=watt_mean))+
 # geom_line(aes(y=w_2mmol, color = "2mmol"))+
  # geom_line(aes(y= km, color = "km"))+
  #geom_line(aes(y= ftp, color = "FTP"))
```


```{r}
NP_berechnen(ridedata)

calculate_TSS(ridedata,260)
tibble(TSS = calculate_TSS(ridedata,260),
       NP = calculate_NP(ridedata),
       km2 = ridedata%>% summarise(km = max(KM,na.rm = TRUE))%>% pull()) %>%
bind_cols(aggregation_rides[[2]])
```


### Bewegungszeit vs Zeit

2021-09-11  dauer:  7:24:48  4:14:10 zeit, 4:12:42 in bewegung
71,966km höhengewinn: 2001m eingegeben

Ich komme nicht genau hin, besser wird es mit WATTS == 0, aber dann problem mit aktivitäten ohne watt..

```{r}
ridedata %>%  mutate(time_diff = SECS - lag(SECS, default = 0),
                     km_diff = KM - lag(KM, default = 0),
                     time_diff_movement = if_else(KPH ==0 & km_diff == 0 , time_diff, time_diff-1)) %>%
              summarise(duration_seconds = (max(SECS)),
                        duration = seconds_to_period(duration_seconds),
                        time_diff = sum(time_diff-1,na.rm = TRUE), #-1 because 1 is the regular time gap
                       aufzeichnungszeit = seconds_to_period(max(SECS) - time_diff ),
                       bewegungszeit = seconds_to_period(max(SECS) - sum(time_diff_movement )),
                       km = sum(km_diff))


```

```{r}
calculate_movement_time <- function(ridedata){
  result <- ridedata %>%  mutate(time_diff = SECS - lag(SECS, default = 0),
                                 km_diff = KM - lag(KM, default = 0),
                                 time_diff_movement = if_else(KPH ==0 & km_diff == 0 , 
                                                              time_diff, time_diff-1)) %>%
              summarise(movement_time = (max(SECS) - sum(time_diff_movement )))  #seconds_to_period()
  return(result$movement_time)
}

calculate_movement_time(ridedata)
```



```{r}
data_prepare <- ridedata %>%mutate(time_diff = SECS - lag(SECS, default = 0),
                     km_diff = KM - lag(KM, default = 0),
                     time_diff_movement = if_else(km_diff ==0, time_diff, time_diff-1),
                    km_diff_factor = if_else(km_diff!=0, "bewegung", "0"))

data_prepare%>%
  ggplot(aes(x = SECS))+
  geom_point(aes(y=KM, color = as.factor(km_diff_factor)))
```

```{r}
data_prepare%>% filter(SECS > 20300 &
                         SECS < 21000) %>%
  ggplot(aes(x = SECS))+
  geom_point(aes(y=KM, color = as.factor(km_diff_factor)))
```

```{r}
data_prepare%>% filter(SECS > 20300 &
                         SECS < 21000) %>%
 mutate(km_diff = KM - lag(KM))%>%
  select(SECS, KM, km_diff, WATTS, KPH, time_diff, km_diff, time_diff_movement) 
```


```{r}
data_prepare %>% arrange(desc(time_diff))
```

### Höhengewinn ausrechnen

```{r}
 data_prepare %>% 
            arrange(SECS) %>% mutate(uphill = ALT-lag(ALT),
                        uphill = if_else(uphill >0, 
                                         if_else(uphill < 1,uphill,0), #more than 1m/sec is too much (at the start when no altitude is available)
                                         0)) %>%
  summarise(uphill = sum(uphill,na.rm = TRUE))
```

```{r}
calculate_elevation_gain <- function(ridedata){
   result <- ridedata %>% 
            arrange(SECS) %>% mutate(uphill = ALT-lag(ALT),
                        uphill = if_else(uphill >0, 
                                         if_else(uphill < 1,uphill,0), #more than 1m/sec is too much (at the start when no altitude is available)
                                         0)) %>%
  summarise(uphill = sum(uphill,na.rm = TRUE))
   return(result$uphill)
  
}

calculate_elevation_gain(data_prepare)
```



```{r}
ridedata %>% mutate(sec_diff = SECS - lag(SECS)) %>% count(sec_diff)
```


```{r}
#samples
```



```{r mehrere files}


data_ride <- list()
data_rides <- list()
for (i in seq_along(files_selected$file_name)) {
  print(i)
  datei <- str_c(pfad_aktivity,files_selected$file_name[i])
  try({
     data_ride <- read_json(datei)
     
            #sind trainingsdaten vorhanden ?
            samples <- sum(names(data_ride[[1]]) == "SAMPLES")
            
            if (samples == 1) {
     
                ridedata_list <- data_ride[[1]]$SAMPLES
                ridedata <- bind_rows(ridedata_list)
                ridedata <- ridedata %>% mutate(sec = SECS- lag(SECS),
                                                type = "ohne Daten")
              
            }
  
               
            ridedata <- ridedata %>% mutate(workout = data_ride[[1]]$TAGS$`Workout Code`,
                                            time_start = data_ride[[1]]$STARTTIME,
                                            date = as.Date(time_start), 
                                            year =year(date)  ,
                                            month= month(date),
                                            week = week(date),
                                            time_start = as.POSIXct(time_start),
                                            #beschreibung = data_ride[[1]]$TAGS$Objective, #braucht viel speicher?
                                            cp = data_ride[[1]]$TAGS$CP,
                                            rad = data_ride[[1]]$TAGS$Rad)
            #WATTS enthalten?
            watt <- sum(names(ridedata) == "WATTS")
            
            if (watt == 1) {
              
              ridedata <- ridedata %>% mutate(zone = if_else(WATTS %in% watt_z1,
                                                "Z1",
                                                if_else(WATTS %in% watt_z2, 
                                                        "Z2", 
                                                        if_else(WATTS %in% watt_z3,
                                                                "Z3",
                                                                "easy"))),
                                              type = "Zonen")
            }else{
              ridedata <- ridedata %>% mutate(type = "keine Watt")
            }
            
            
      data_rides[[i]] <-  ridedata
    }) #try ENDE
}

ridedata <- bind_rows(data_rides)

#save the data:
#ridedata %>% write_rds(str_c("./Results/trainingsdata_",year_selected,".rds"))
#ridedata <- read_rds(str_c("./Results/trainingsdata_",year_selected,".rds"))

```

```{r}
ridedata %>% colnames()

ridedata %>% group_by(workout) %>%
              summarise(duration = max(SECS),
                        km = max(KM),
                        elevation_gain = max(ALT))
```

## OFFENE PUNKTEN Letztstand vermutlich



FTP für die SST berechnung mit berücksichtigen
--> wichtig wäre die tss anhand der ftp tabelle zu berechnen, da müßte man mehr werte schätzen oder interpolieren? --> dann herausfinden ob es einen zusammenhang tss/woche und ftp gibt
z.B. tss der letzten 8 wochen --> ftp?

aggregationen: beste 20min, 60min, 5min 1min 10sec.. vielleicht gibt es funktion?
varianz in trainingseinheit ein indiz für intervalltraining?


vielleicht 5min mittelwerte machen --> streuung und max summarise --> für Quali von GA1

## Pipeline

```{r}
data_ride <- list()
data_rides <- list()
aggregated_list <- list()
for (i in seq_along(files_selected)) {
  

aggregated <- c()
ridedata_samples <- c()
ridedata <- c()
#aggregated_rides <- list()

  datei <- str_c(pfad_aktivity,files_selected[i])
 try({
     data_ride <- read_json(datei)
     
     
        ridedata <-tibble(workout = data_ride[[1]]$TAGS$`Workout Code`,
                   time_start = as.POSIXct(data_ride[[1]]$STARTTIME),
                   date = as.Date(time_start),
                   year =year(date)  ,
                   month= month(date),
                   week = week(date)) %>%
      mutate(helper = str_to_upper(workout),
                               kategorie = case_when(
                                 str_detect(helper,"GA1") ~ "GA1",
                                 str_detect(helper,"SST") ~ "SST",
                                 str_detect(helper,"VO2MAX") ~ "VO2max",
                                 str_detect(helper,"KRAFTTRAINING") ~ "Krafttraining",
                                 str_detect(helper,"HOUR OF P") ~ "Hour of Power",
                                 str_detect(helper,"FTP TEST") ~ "FTP Test",
                                 str_detect(helper,"RENNEN") ~ "Rennen",
                                 TRUE ~ "Sonstige"
                               )) %>% select(-helper)
 
        #kommt das Feld Rad vor?
 rad <- sum(names(data_ride[[1]]$TAGS) == "Rad")
 if (rad == 1) {
            ridedata$rad <- data_ride[[1]]$TAGS$Rad
 }else{
            ridedata$rad <- ""
 }

#Manuell veränderte Werte wie TSS, höhengwinn:---------------
#Stehen in data_ride[[1]]$OVERRIDES[[1]]

elevation_gain <- sum(names(data_ride[[1]]$OVERRIDES[[1]]) == "elevation_gain")
coggan_tss <- sum(names(data_ride[[1]]$OVERRIDES[[1]]) == "coggan_tss")

print(coggan_tss)
ridedata <- ridedata %>% 
                mutate(TSS = as.numeric(if_else(coggan_tss == 0,
                                                "0",
                                                data_ride[[1]]$OVERRIDES[[1]]$coggan_tss$value)),
                       hoehen_gewinn = as.numeric(if_else(elevation_gain == 0,
                                                         "0",
                                                        data_ride[[1]]$OVERRIDES[[1]]$elevation_gain$value)))



#allgemeine aggregationen----------------------------
   #aggregated_rides[[i]]
   aggregated <-ridedata %>% summarise(workout = first(workout),
                                       kategorie =first(kategorie),
                                          date = first(date),
                                          device = first(rad),
                                       TSS = first(TSS), #sollte TSS manuel eingegeben worden sein
                                       hoehen_gewinn = first(hoehen_gewinn))   
        
#--------------Trainingsdaten---------------------------------------------
#gibt es trainingsdaten?
samples <- sum(names(data_ride[[1]]) == "SAMPLES")
                 
  if (samples == 1) {
    ridedata_list <- data_ride[[1]]$SAMPLES
   ridedata_samples <- bind_rows(ridedata_list) 
   #%>% 
    #                          mutate(WATTS = as.double(WATTS),
     #                                HR = as.double(HR),
      #                               CAD = as.double(CAD))
   
     
  
  # Welche trainingsdaten gibt es - watt, temp,hr,... verschieden je nach sport    
     variablen <-  ridedata_samples %>% colnames()
     variablen_mean <- ridedata_samples %>% select(-SECS, -KM, -ALT, -LAT, -LON, -SLOPE)%>% colnames()

        #Mittelwerte berechnen
         agg_mean <-  ridedata_samples %>% summarise_at(vars(variablen_mean), ~mean(.x,na.rm = TRUE))  
         #Maximalwerte berechnen
         agg_max <- ridedata_samples %>% summarise(km = max(KM),
                                          n=n(),
                                          duration = hms::as_hms(n()))
        aggregated <-  aggregated %>%  bind_cols(agg_mean) %>% bind_cols(agg_max) 
        
        #TSS,NP berechnen
        aggregated <- aggregated %>%  mutate(TSS =  if_else(TSS == 0,
                                                            TSS_berechnen(ridedata_samples,FTP),
                                                            TSS),
                                              NP =  NP_berechnen(ridedata_samples),
                                              IF = IF_berechnen(ridedata_samples,FTP))
        # Beste xmin Watt
        #Vorsicht, langsam
        agg_beste <- c()
        agg_beste <-  tibble(beste_60 = beste_watt(ridedata_samples,60),
                             beste_20 = beste_watt(ridedata_samples,20),
                             beste_10 = beste_watt(ridedata_samples,10),
                             beste_5 = beste_watt(ridedata_samples,5),
                             beste_1 = beste_watt(ridedata_samples,1),
                             beste_3sek = beste_watt(ridedata_samples,3/60),
                             #beste_1sek = beste_watt(ridedata_samples,1/60)
                             )
        aggregated <-  aggregated %>%  bind_cols(agg_beste)
        
        
        #5min auswertung, ziel ist, ga1 einheiten zu bewerten
        agg_w5 <- w5_auswertung(ridedata_samples)
        agg_hr5 <- hr5_auswertung(ridedata_samples)
        aggregated <-  aggregated %>%  bind_cols(agg_w5) %>% bind_cols(agg_hr5)
         
 
  }  
 }) #try
      aggregated_list[[i]] <- aggregated
}

bind_rows(aggregated_list)
```


## Select files by date
```{r}
start_date <- "2021-09-10"
end_date <- "2022-01-01"


#files_select <- files[1400:1420]



date_selected <- tibble(file_date = seq.Date(as.Date(start_date),
                                             as.Date(end_date), 
                                             by = "day") )
date_selected <- date_selected %>% mutate(file_date = str_replace_all(as.character(file_date),"-","_"))

files_selected <- files  %>% right_join(date_selected, 
                             by= "file_date") %>% 
                  filter(!is.na(file_name)) %>% #if the date doesn`t exist in the data
                  select(file_name) %>% pull()




files_selected

```

## Select files per year

```{r}
year_selected <- c("2021")

files_selected <- files %>% filter(file_year %in% year_selected)
```



```{r mehrere files}

data_ride <- list()
data_rides <- list()
for (i in seq_along(files_selected$file_name)) {
  print(i)
  datei <- str_c(pfad_aktivity,files_selected$file_name[i])
  try({
     data_ride <- read_json(datei)
     
            #sind trainingsdaten vorhanden ?
            samples <- sum(names(data_ride[[1]]) == "SAMPLES")
            
            if (samples == 1) {
     
                ridedata_list <- data_ride[[1]]$SAMPLES
                ridedata <- bind_rows(ridedata_list)
                ridedata <- ridedata %>% mutate(sec = SECS- lag(SECS),
                                                type = "ohne Daten")
              
            }
  
               
            ridedata <- ridedata %>% mutate(workout = data_ride[[1]]$TAGS$`Workout Code`,
                                            time_start = data_ride[[1]]$STARTTIME,
                                            date = as.Date(time_start), 
                                            year =year(date)  ,
                                            month= month(date),
                                            week = week(date),
                                            time_start = as.POSIXct(time_start),
                                            #beschreibung = data_ride[[1]]$TAGS$Objective, #braucht viel speicher?
                                            cp = data_ride[[1]]$TAGS$CP,
                                            rad = data_ride[[1]]$TAGS$Rad)
            #WATTS enthalten?
            watt <- sum(names(ridedata) == "WATTS")
            
            if (watt == 1) {
              
              ridedata <- ridedata %>% mutate(zone = if_else(WATTS %in% watt_z1,
                                                "Z1",
                                                if_else(WATTS %in% watt_z2, 
                                                        "Z2", 
                                                        if_else(WATTS %in% watt_z3,
                                                                "Z3",
                                                                "easy"))),
                                              type = "Zonen")
            }else{
              ridedata <- ridedata %>% mutate(type = "keine Watt")
            }
            
            
      data_rides[[i]] <-  ridedata
    }) #try ENDE
}

ridedata <- bind_rows(data_rides)

#save the data:
ridedata %>% write_rds(str_c("./Results/trainingsdata_",year_selected,".rds"))
#ridedata <- read_rds(str_c("./Results/trainingsdata_",year_selected,".rds"))

```


# Analyse
```{r}
ridedata %>% filter(type == "Zonen") %>% group_by(month,zone,rad, time_start) %>% summarise(km=max(KM),
                                    hr = mean(HR),
                                    watt = mean(WATTS),
                                    zeit = sum(sec,na.rm = TRUE)) %>%
  group_by(month, zone) %>% summarise(km = sum(km),
                                    hr = mean(hr),
                                    watt = mean(watt),
                                    zeit = sum(zeit,na.rm = TRUE)/3600) %>%
  ggplot(aes(x=month))+
  geom_point(aes(y=zeit, color=as.factor(zone)))#+
  geom_point(aes(y=hr, color = "HR"))
```


```{r}
#write_rds(ridedata,"test_mit_beschreibung.rds")

#ridedata <- read_rds("test_mit_beschreibung.rds")
```

```{r}
ridedata %>% group_by(week,rad,time_start, date) %>% summarise(km=max(KM),
                                    hr = mean(HR),
                                    watt = mean(WATTS)) %>%
  group_by(date) %>% 
      summarise(km = sum(km)) %>% 
        arrange(date) %>%
          mutate(km_cum = cumsum(km)) %>%
  ggplot(aes(x=date))+
  geom_line(aes(y= km_cum))
```

```{r}
ridedata %>% group_by(week,rad,time_start, date) %>% summarise(km=max(KM),
                                    hr = mean(HR),
                                    watt = mean(WATTS)) %>%
  group_by(date) %>% 
      summarise(km = sum(km)) %>% 
        arrange(date) %>%
          mutate(km_cum = cumsum(km)) %>%
  ggplot(aes(x=date))+
  geom_line(aes(y= km_cum))
```



```{r}
ridedata %>% group_by(week,rad,time_start, date) %>% summarise(km=max(KM),
                                    hr = mean(HR),
                                    watt = mean(WATTS)) %>%
  group_by(rad,date) %>% 
      summarise(km = sum(km)) %>% 
  
        arrange(date) %>%
          mutate(km_cum = cumsum(km)) %>% #filter(rad=="P2Cros ")
  ggplot(aes(x=date))+
  geom_line(aes(y= km_cum, color = rad))
```




```{r}
ridedata %>% group_by(week,rad,time_start, date) %>% summarise(km=max(KM),
                                    hr = mean(HR),
                                    watt = mean(WATTS)) %>%
  group_by(date) %>% 
      summarise(hr = mean(hr),
                watt = mean(watt)) %>% 
  ggplot(aes(x=date))+
  geom_line(aes(y= hr, color ="hr"))+
  geom_line(aes(y=watt, color = "watt"))
```



```{r}
ridedata %>% group_by(week,zone,rad, time_start) %>% summarise(km=max(KM),
                                    hr = mean(HR),
                                    watt = mean(WATTS)) %>%
  group_by(week, zone) %>% summarise(km = sum(km),
                                    hr = mean(hr),
                                    watt = mean(watt)) %>%
  ggplot(aes(x=hr))+
  geom_point(aes(y=watt, color=as.factor(week)))+
  geom_point(aes(y=hr, color = "HR"))+
  facet_grid(zone~.)

```

```{r}
ridedata  %>% group_by(month,rad, time_start) %>% summarise(km=max(KM),
                                    hr = mean(HR),
                                    watt = mean(WATTS)) %>%
  group_by(month) %>% summarise(km = sum(km),
                                    hr = mean(hr),
                                    watt = mean(watt)) %>%
  ggplot(aes(x=watt))+
  #geom_point(aes(y=watt, color="watt"))+
  geom_point(aes(y=hr, color = as.factor(month)))

```


```{r}
ridedata %>% glimpse()
 ridedata %>% summary()

```

```{r}
ridedata %>% mutate(date = as.Date(time_start), 
                    year =year(date)  ,
                    month= month(date),
                    week = week(date),
                    time_start = as.POSIXct(time_start)) %>% 
  select(time_start, date, year, month, week)
```



```{r}
datei_info <- gc_data[[1]][[6]]
datei_info$`Workout Code`
datei_info$Objective
```

```{r}

#MEtriken Änderung:
data4[[1]][[5]]
```

```{r}
#Intervalle
data4[[1]][[7]]
```

```{r}

ridedata_list <- gc_data[[1]][[8]]
ridedata <- bind_rows(ridedata_list)

```

```{r}
ridedata %>% ggplot(aes(x=SECS))+
  geom_point(aes(y=WATTS, color = "Watt"))+
  labs(title = datei_info$`Workout Code`)

```
## Mehrere Dateien Watt auslesen

```{r}
files <- list.files(pfad_aktivity)
summary(files)
```

```{r mehrere files}
files_select <- files[1300:1420]

data_ride <- list()
data_rides <- list()
for (i in seq_along(files_select)) {
  datei <- str_c(pfad_aktivity,files_select[i])
   data_ride <- read_json(datei)
          ridedata_list <- data_ride[[1]]$SAMPLES
          ridedata <- bind_rows(ridedata_list)
   
          ridedata <- ridedata %>% mutate(workout = data_ride[[1]]$TAGS$`Workout Code`,
                                          time_start = data_ride[[1]]$STARTTIME,
                                          beschreibung = data_ride[[1]]$TAGS$Objective,
                                          cp = data_ride[[1]]$TAGS$CP,
                                          rad = data_ride[[1]]$TAGS$Rad)
    data_rides[[i]] <-  ridedata

}

ridedata <- bind_rows(data_rides)

data_ride[[1]]$DEVICETYPE
```

```{r}
ridedata %>% group_by(rad) %>% summarise(max(WATTS))
```



```{r}

### Karte
ridedata %>% filter(LAT > 40 ) %>% ggplot( aes(LON, LAT)) + 
  geom_point(aes(color= WATTS),size = .25, show.legend = FALSE) +
  coord_quickmap()#coord_sf()


```

```{r osmdata}

#https://dominicroye.github.io/en/2018/accessing-openstreetmap-data-with-r/
q <- getbb("Madrid") %>%
      opq() %>%
       add_osm_feature("amenity", "cinema")

str(q)

cinema <- osmdata_sf(q)
cinema

#our background map
mad_map <- get_map(getbb("niederoesterreich"), maptype = "toner-background")

ggmap(mad_map)
?get_map
?getbb

test <- ridedata %>% filter(LAT > 40 ) 

background <- get_map(location = c(14.6,48))
ggmap(mad_map)
ggmap(mad_map) + geom_point(data = test,aes(x=LON,y=LAT)) #+  coord_cartesian(xlim=c(14.5,15))

mapi <- openmap(c(lat= 14.5,   lon= 14.7),
			c(lat= 47,   lon= 49), minNumTiles=9)#, type ="maptoolkit-topo") 
  
?openmap

```



```{r}
files <- list.files(pfad_aktivity)
```

```{r}
selected_files <- files[1400:1411]
gc_data_list <- list()
ridedata <- list()
for (i in seq_along(selected_files)) {

  gc_data <- read_json(str_c(pfad_aktivity, selected_files[i]))
  ridedata_list <- gc_data[[1]][[8]]
  ridedata[[i]] <- bind_rows(ridedata_list)

}

test <- bind_rows(ridedata)
```

```{r}
### Karte
test %>% filter(LAT > 2) %>% ggplot( aes(LON, LAT)) + 
  geom_point(aes(color= WATTS),size = .25, show.legend = FALSE) +
  coord_quickmap()#coord_sf()

```

```{r}
heat <- test %>% filter(LAT >47.96 &
                          LAT < 47.968 &
                          LON > 14.76 &
                          LON < 14.79) %>% 
  group_by(LAT,LON) %>% count
```

```{r}
plot1 <-heat %>% filter(LAT > 2) %>% ggplot( aes(LON, LAT)) + 
  geom_point(aes(color= n),size = .25, show.legend = FALSE)+
  scale_color_gradient(low = "blue", high = "red")  #+coord_quickmap()#coord_sf()

ggplotly(plot1)
```

```{r}
require(maps)
require(ggplot2)

mp <- openmap(c(53.38332836757155,-130.517578125),
		c(15.792253570362446,-67.939453125),4,'stamen-watercolor')
mp_bing <- openmap(c(53.38332836757155,-130.517578125),
		c(15.792253570362446,-67.939453125),4,'bing')
states_map <- map_data("state")
states_map_merc <- as.data.frame(
		projectMercator(states_map$lat,states_map$long))
states_map_merc$region <- states_map$region
states_map_merc$group <- states_map$group
crimes <- data.frame(state = tolower(rownames(USArrests)), USArrests)

p <- autoplot(mp,expand=FALSE) + geom_polygon(aes(x=x,y=y,group=group),
		data=states_map_merc,fill="black",colour="black",alpha=.1) + theme_bw()
print(p)
p <- autoplot(mp_bing) + geom_map(aes(x=-10000000,y=4000000,map_id=state,fill=Murder),
		data=crimes,map=states_map_merc)
print(p)

```

